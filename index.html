<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fahrzeugcheck</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2b2b2b">
  <style>
    body { font-family: sans-serif; margin: 20px; }
    h2, h3 { margin-top: 20px; }
    .section { border: 1px solid #aaa; padding: 10px; margin-top: 10px; }
    label { display: block; margin: 6px 0; }
    textarea, input, select { width: 100%; padding: 6px; margin-top: 4px; }
    button { margin-top: 20px; padding: 10px; font-size: 16px; }
    button:disabled { background: #ccc; }
    .hinweis { margin-top: 10px; font-size: 12px; color: #444; }
    #signature-pad { border: 1px solid #aaa; display: none; margin-top: 10px; touch-action: none; }
  </style>
</head>
<body>
  <h2>Fahrzeugzustand bei Schichtbeginn</h2>

  <label>Fahrzeug:
    <select id="fahrzeug" required>
      <option value="">Bitte auswählen...</option>
      <option value="T36">T36</option>
      <option value="T37">T37</option>
      <option value="T38">T38</option>
      <option value="T39">T39</option>
      <option value="T40">T40</option>
    </select>
  </label>

  <label>Name:
    <input type="text" id="name" required>
  </label>
  <label>Kennzeichen:
    <input type="text" id="kennzeichen" required>
  </label>
  <label>Datum:
    <input type="date" id="datum" required>
  </label>

  <div class="section">
    <label><input type="radio" name="beginn" value="Das Fahrzeug ist außen verschmutzt. Der Innenraum ist verschmutzt." required>
      Das Fahrzeug ist außen verschmutzt. Der Innenraum ist verschmutzt.</label>
    <label><input type="radio" name="beginn" value="Das Fahrzeug ist ohne größere Beanstandungen für den Dienst einsetzbar.">
      Das Fahrzeug ist ohne größere Beanstandungen für den Dienst einsetzbar.</label>
    <label><input type="radio" name="beginn" value="Das Fahrzeug hat neue Schäden. Bitte skizzieren und beschreiben.">
      Das Fahrzeug hat neue Schäden. Bitte skizzieren und beschreiben.</label>
    <textarea id="schadenbeschreibung" placeholder="Beschreibung/Skizze"></textarea>
  </div>

  <h2>Fahrzeugzustand bei Schichtende</h2>
  <div class="section">
    <label><input type="checkbox" id="ende1" value="Tankfüllung ist ausreichend (mindestens 150km).">
      Tankfüllung ist ausreichend (mindestens 150km).</label>
    <label><input type="checkbox" id="ende2" value="Das Fahrzeug weist keine neuen Gebrauchsspuren im Inneren/Karosserie auf.">
      Das Fahrzeug weist keine neuen Gebrauchsspuren im Inneren/Karosserie auf.</label>
    <label><input type="checkbox" id="ende3" value="Am Fahrzeug ist ein Schaden entstanden und habe diesen gemeldet.">
      Am Fahrzeug ist ein Schaden entstanden und habe diesen gemeldet.</label>
    <label><input type="checkbox" id="ende4" value="Das Fahrzeug hat Fehlermeldungen ausgewiesen – bitte prüfen!">
      Das Fahrzeug hat Fehlermeldungen ausgewiesen – bitte prüfen!</label>
  </div>

  <h3>Bemerkungen</h3>
  <textarea id="bemerkungen"></textarea>

  <!-- Unterschrift -->
  <button type="button" id="signBtn">Unterschrift</button>
  <canvas id="signature-pad" width="300" height="150"></canvas>
  <button type="button" id="clearSig" style="display:none;">Unterschrift löschen</button>

  <button id="submitBtn" disabled>Bestätigen</button>
  <div class="hinweis">
    Durch Drücken des Buttons bestätige ich, dass die Überprüfung von mir gewissenhaft und wahrheitsgemäß durchgeführt und dokumentiert wurde.
  </div>

  <script>
    const inputs = document.querySelectorAll("input, textarea, select");
    const button = document.getElementById("submitBtn");
    const signBtn = document.getElementById("signBtn");
    const signaturePad = document.getElementById("signature-pad");
    const clearSigBtn = document.getElementById("clearSig");

    let hasSignature = false;
    let drawing = false;
    const ctx = signaturePad.getContext("2d");
    ctx.strokeStyle = "#000";
    ctx.lineWidth = 2;

    function checkForm() {
      const fahrzeug = document.getElementById("fahrzeug").value.trim();
      const name = document.getElementById("name").value.trim();
      const kennz = document.getElementById("kennzeichen").value.trim();
      const datum = document.getElementById("datum").value.trim();
      const beginn = document.querySelector("input[name='beginn']:checked");

      if (fahrzeug && name && kennz && datum && beginn && hasSignature) {
        button.disabled = false;
      } else {
        button.disabled = true;
      }
    }

    inputs.forEach(i => i.addEventListener("input", checkForm));

    // Unterschrift anzeigen
    signBtn.addEventListener("click", () => {
      signaturePad.style.display = "block";
      clearSigBtn.style.display = "inline-block";
    });

    function getPos(e) {
      let rect = signaturePad.getBoundingClientRect();
      if (e.touches) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      } else {
        return {
          x: e.offsetX,
          y: e.offsetY
        };
      }
    }

    function startDraw(e) {
      e.preventDefault();
      drawing = true;
      const pos = getPos(e);
      ctx.beginPath();
      ctx.moveTo(pos.x, pos.y);
    }

    function draw(e) {
      if (!drawing) return;
      e.preventDefault();
      const pos = getPos(e);
      ctx.lineTo(pos.x, pos.y);
      ctx.stroke();
      hasSignature = true;
      checkForm();
    }

    function endDraw(e) {
      e.preventDefault();
      drawing = false;
    }

    // Maus
    signaturePad.addEventListener("mousedown", startDraw);
    signaturePad.addEventListener("mousemove", draw);
    signaturePad.addEventListener("mouseup", endDraw);
    signaturePad.addEventListener("mouseout", endDraw);

    // Touch
    signaturePad.addEventListener("touchstart", startDraw);
    signaturePad.addEventListener("touchmove", draw);
    signaturePad.addEventListener("touchend", endDraw);

    // Löschen
    clearSigBtn.addEventListener("click", () => {
      ctx.clearRect(0, 0, signaturePad.width, signaturePad.height);
      hasSignature = false;
      checkForm();
    });

    // Mailversand
    button.addEventListener("click", () => {
      const fahrzeug = document.getElementById("fahrzeug").value;
      const beginn = document.querySelector("input[name='beginn']:checked").value;
      const schaden = document.getElementById("schadenbeschreibung").value;
      const bemerkungen = document.getElementById("bemerkungen").value;

      let ende = [];
      ["ende1","ende2","ende3","ende4"].forEach(id => {
        const box = document.getElementById(id);
        if (box.checked) ende.push(box.value);
      });

      // Unterschrift als Base64-Bild
      const signatureImage = signaturePad.toDataURL("image/png");

      const body = `
Fahrzeugzustand bei Schichtbeginn
Fahrzeug: ${fahrzeug}
Name: ${document.getElementById("name").value}
Kennzeichen: ${document.getElementById("kennzeichen").value}
Datum: ${document.getElementById("datum").value}

--- Schichtbeginn ---
${beginn}
${schaden ? "Schaden: " + schaden : ""}

--- Schichtende ---
${ende.join("\n")}

Bemerkungen:
${bemerkungen}

Unterschrift (PNG, Base64):
${signatureImage}
`;

      const mailto = `mailto:webjere@magenta.de?subject=Fahrzeugcheck&body=${encodeURIComponent(body)}`;
      window.location.href = mailto;
    });

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>
</body>
</html>
